<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Prompt&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: 'Prompt', sans-serif !important;
    }
  </style>
  <title>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</title>
  <link rel="icon" href="https://fsms.iqoption.com/storage/public/5f/7a/fa83cf9ba7f8e8f0b7.png" type="image/png">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
</head>

<body class="bg-gray-900 text-white font-sans">
  <div class="max-w-md mx-auto p-4">
    <!-- üîô ‡∏õ‡∏∏‡πà‡∏°‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö -->
    <div class="flex items-center mb-4">
      <button onclick="window.history.back()" class="text-white text-2xl">
        <i class="fas fa-arrow-left"></i>
      </button>
      <h1 class="text-center flex-grow text-lg font-semibold">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</h1>
    </div>

    <!-- ‚úÖ ‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô -->
    <div class="text-center mb-4">
      <p class="text-lg">
        ‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô:
        <span id="current-balance" class="text-yellow-400">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</span> USDT
      </p>
    </div>

    <!-- ‚úÖ ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ù‡∏≤‡∏Å-‡∏ñ‡∏≠‡∏ô -->
    <h2 class="text-center font-bold mb-2">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ù‡∏≤‡∏Å-‡∏ñ‡∏≠‡∏ô</h2>
    <div id="transaction-history" class="space-y-2">
      <p class="text-center text-red-400">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", async () => {
      const API_URL = "http://localhost:4000/api";
      const token = localStorage.getItem("token");

      if (!token) {
        alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ");
        window.location.href = "login.html";
        return;
      }

      try {
        const balanceRes = await fetch(`${API_URL}/wallet/balance`, {
          method: "GET",
          headers: { Authorization: `Bearer ${token}` },
        });

        const balanceData = await balanceRes.json();
        if (balanceRes.ok) {
          document.getElementById("current-balance").textContent = balanceData.balance.toFixed(2);
        } else {
          document.getElementById("current-balance").textContent = "‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î";
        }

        // ‚úÖ ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏° (‡∏ù‡∏≤‡∏Å/‡∏ñ‡∏≠‡∏ô)
        const transactionsRes = await fetch(`${API_URL}/transactions/user-history`, {
          method: "GET",
          headers: { Authorization: `Bearer ${token}` },
        });

        const transactionsData = await transactionsRes.json();
        const historyContainer = document.getElementById("transaction-history");

        if (transactionsRes.ok) {
          historyContainer.innerHTML = "";

          if (transactionsData.length === 0) {
            historyContainer.innerHTML = "<p class='text-center text-gray-400'>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ù‡∏≤‡∏Å-‡∏ñ‡∏≠‡∏ô</p>";
            return;
          }

          transactionsData.forEach((tx) => {
            const txItem = document.createElement("div");
            txItem.classList.add("p-3", "rounded", "text-sm", "flex", "justify-between", "items-center");

            const formattedDate = new Date(tx.createdAt).toLocaleString("th-TH", {
              day: "2-digit",
              month: "2-digit",
              year: "numeric",
              hour: "2-digit",
              minute: "2-digit",
              second: "2-digit",
            });

            let colorClass = "text-gray-300";
            let amountText = `${tx.amount.toFixed(2)} USDT`;

            if (tx.type === "deposit") {
              colorClass = "text-green-400";
              amountText = `+${amountText}`;
            } else if (tx.type === "withdraw") {
              colorClass = "text-red-400";
              amountText = `- ${amountText}`;
            }

            // ‚úÖ ‡πÅ‡∏Å‡πâ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ: ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏´‡∏•‡∏≤‡∏¢‡∏Ñ‡πà‡∏≤ status ‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡∏ß‡πà‡∏≤ "‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"
            let statusText = `<span class="text-yellow-400"> ‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</span>`;
            if (
              tx.status === "succeed" ||
              tx.status === "approved" ||
              tx.status === "success"
            ) {
              statusText = `<span class="text-green-400"> ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</span>`;
            } else if (tx.status === "rejected" || tx.status === "failed") {
              statusText = `<span class="text-red-400"> ‡∏ñ‡∏π‡∏Å‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</span>`;
            }

            txItem.innerHTML = `
              <span>USDT</span>
              <span class="text-xs">${formattedDate}</span>
              <span class="${colorClass}">${amountText}</span>
              ${statusText}
            `;

            historyContainer.appendChild(txItem);
          });
        } else {
          historyContainer.innerHTML = "<p class='text-center text-red-400'>‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>";
        }
      } catch (error) {
        console.error("‚ùå Error fetching transactions:", error);
        document.getElementById("transaction-history").innerHTML =
          "<p class='text-center text-red-400'>‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>";
      }
    });
  </script>
</body>
</html>
